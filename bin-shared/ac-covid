#!/bin/sh

# old one
# curl -sS 'https://services3.arcgis.com/1iDJcsklY3l3KIjE/arcgis/rest/services/AC_dates2/FeatureServer/0/query?f=json&where=1%3D1&returnGeometry=false&spatialRel=esriSpatialRelIntersects&outFields=*&orderByFields=Date%20asc&resultOffset=0&resultRecordCount=32000&resultType=standard&cacheHint=true' \
#| fx '.features.map(({ attributes: a }) => `${new Date(a.Date).toISOString()}\t${a.AC_CumulCases}`).slice(-40).join("\n")'


curl -sS \
  --data-binary '{"version":"1.0.0","queries":[{"Query":{"Commands":[{"SemanticQueryDataShapeCommand":{"Query":{"Version":2,"From":[{"Name":"v","Entity":"V_Combined_data","Type":0}],"Select":[{"Column":{"Expression":{"SourceRef":{"Source":"v"}},"Property":"DtCreate"},"Name":"V_Combined_data.DtCreate"},{"Measure":{"Expression":{"SourceRef":{"Source":"v"}},"Property":"Cumulative Cases"},"Name":"V_Combined_data.Cumulative Cases"}]},"Binding":{"Primary":{"Groupings":[{"Projections":[0,1]}]},"DataReduction":{"DataVolume":4,"Primary":{"BinnedLineSample":{}}},"Version":1}}}]},"CacheKey":"{\"Commands\":[{\"SemanticQueryDataShapeCommand\":{\"Query\":{\"Version\":2,\"From\":[{\"Name\":\"v\",\"Entity\":\"V_Combined_data\",\"Type\":0}],\"Select\":[{\"Column\":{\"Expression\":{\"SourceRef\":{\"Source\":\"v\"}},\"Property\":\"DtCreate\"},\"Name\":\"V_Combined_data.DtCreate\"},{\"Measure\":{\"Expression\":{\"SourceRef\":{\"Source\":\"v\"}},\"Property\":\"Cumulative Cases\"},\"Name\":\"V_Combined_data.Cumulative Cases\"}]},\"Binding\":{\"Primary\":{\"Groupings\":[{\"Projections\":[0,1]}]},\"DataReduction\":{\"DataVolume\":4,\"Primary\":{\"BinnedLineSample\":{}}},\"Version\":1}}}]}","QueryId":"","ApplicationContext":{"DatasetId":"d4923c43-5fc4-444c-aa95-8ecf0d15f562","Sources":[{"ReportId":"5080f005-6411-4a22-88b0-ff13c00d140f"}]}}],"cancelQueries":[],"modelId":295360}' \
  'https://wabi-us-gov-iowa-api.analysis.usgovcloudapi.net/public/reports/querydata?synchronous=true' \
  | gunzip \
  | fx '.results[0].result.data.dsr.DS[0].PH[0].DM0.map(x => x.C).filter(x => x).map(([t,n]) => `${new Date(t).toISOString()}\t${n}`).slice(-40).join("\n")'
